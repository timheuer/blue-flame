name: Build and Publish

on:
    workflow_dispatch:
    push:
        branches:
            - main
        paths-ignore:
            - "docs/**"
            - "**/*.md"
            - "**/*.gitignore"
            - "**/*.gitattributes"

jobs:
    build:
        permissions:
            contents: write
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - uses: actions/setup-node@v5
              with:
                  node-version: 20

            - name: üì¶ Install dependencies
              run: npm install

            - name: üéÅ Install vsce
              run: npm install -g @vscode/vsce

            - name: üñ•Ô∏è Install cross-env
              run: npm install -g cross-env

            - name: üè∑Ô∏è NBGV
              uses: dotnet/nbgv@v0.4.2
              id: nbgv
              with:
                  stamp: package.json

            - name: üó£Ô∏è NBGV outputs
              run: |
                  echo "SimpleVersion: ${{ steps.nbgv.outputs.SimpleVersion }}"

            - name: üì¶ Package
              run: |
                  echo "GOOGLE_CLIENT_ID length: ${#GOOGLE_CLIENT_ID}"
                  echo "GOOGLE_CLIENT_SECRET length: ${#GOOGLE_CLIENT_SECRET}"
                  vsce package -o ./${{ github.event.repository.name}}.vsix
              env:
                  GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
                  GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}

            - name: üì∞ Publish
              if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
              run: npm run deploy
              env:
                  VSCE_PAT: ${{ secrets.VSCE_PAT }}
                  GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
                  GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}

            - name: üìù Build Summary
              if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
              shell: bash
              run: |
                  echo "## Build Summary" >> "$GITHUB_STEP_SUMMARY"
                  echo "- Final extension version: \`${{ steps.nbgv.outputs.SimpleVersion }}\`" >> "$GITHUB_STEP_SUMMARY"
                  echo "- Marketplace link: https://marketplace.visualstudio.com/items?itemName=timheuer.blue-flame" >> "$GITHUB_STEP_SUMMARY"

            - name: ‚¨ÜÔ∏è Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ github.event.repository.name}}.vsix
                  path: ./*.vsix

            - name: üè∑Ô∏è Tag and Release
              id: tag_release
              uses: softprops/action-gh-release@v2
              with:
                  body: Release ${{ steps.nbgv.outputs.SimpleVersion }}
                  tag_name: ${{ steps.nbgv.outputs.SimpleVersion }}
                  generate_release_notes: true
                  files: ./*.vsix
